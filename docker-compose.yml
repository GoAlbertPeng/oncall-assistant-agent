services:
  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped

  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=mysql+aiomysql://oncall:oncall123@db:3306/oncall
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-super-secret-key-change-in-production}
      # ByteDance Doubao LLM Configuration
      - LLM_PROVIDER=openai
      - OPENAI_API_KEY=08554a38-57c2-4e97-87a5-ddb1d7c15d4e
      - OPENAI_MODEL=doubao-seed-1-6-251015
      - OPENAI_BASE_URL=https://ark.cn-beijing.volces.com/api/v3/
      # Test data sources
      - TEST_PROMETHEUS_URL=http://prometheus:9090
      - TEST_PUSHGATEWAY_URL=http://pushgateway:9091
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  db:
    image: docker.m.daocloud.io/library/mariadb:11
    environment:
      - MARIADB_DATABASE=oncall
      - MARIADB_USER=oncall
      - MARIADB_PASSWORD=oncall123
      - MARIADB_ROOT_PASSWORD=root123
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped

  # Note: Elasticsearch disabled due to high memory requirements (needs 512MB+)
  # Test logs are stored in-memory, test metrics use real Prometheus

  # Prometheus for test metrics data
  prometheus:
    image: m.daocloud.io/docker.io/prom/prometheus:v2.47.0
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-remote-write-receiver'
      - '--web.enable-admin-api'
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    restart: unless-stopped

  # Pushgateway for pushing metrics to Prometheus
  pushgateway:
    image: m.daocloud.io/docker.io/prom/pushgateway:v1.6.2
    ports:
      - "9091:9091"
    restart: unless-stopped

volumes:
  mysql_data:
  prometheus_data: